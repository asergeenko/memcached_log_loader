import pytest
import datetime
import gzip
import os

from optparse import OptionParser

import memc_load_thread as mlt

src = '''idfa	e7e1a50c0ec2747ca56cd9e1558c0d7c	67.7835424444	-22.8044005471	7942,8519,4232,3032,4766,9283,5682,155,5779,2260,3624,1358,2432,1212,528,8182,9061,9628,2055,4821,3550,4964,6924,6737,3784,5428,6980,8137,2129,8751,3000,5495,5674,3023,818,2864,8250,768,6931,3493,3749,8053,8815,8448,8757,272,5951,2831,7186,157,1629,2021,3338,9020,6679,8679,1477,7488,3751,7399,8556,5500,5333,3873,7070,3018,2734,4273,3723,4528,4657,4014
idfa	e7e1a50c0ec2747ca56cd9e1558c0d7c	67.7835424444	-22.8044005471	7942,8519,4232,3032,4766,9283,5682,155,5779,2260,3624,1358,2432,1212,528,8182,9061,9628,2055,4821,3550,4964,6924,6737,3784,5428,6980,8137,2129,8751,3000,5495,5674,3023,818,2864,8250,768,6931,3493,3749,8053,8815,8448,8757,272,5951,2831,7186,157,1629,2021,3338,9020,6679,8679,1477,7488,3751,7399,8556,5500,5333,3873,7070,3018,2734,4273,3723,4528,4657,4014
idfa	f5ae5fe6122bb20d08ff2c2ec43fb4c4	-104.68583244	-51.24448376	4877,7862,7181,6071,2107,2826,2293,3103,9433,2794,4303,7500,5637,8935,6772,2481,1614,3946,7013,690,9474,1655,9718,4862,3367,3869,4255,9431,7333,5471,3267,7439,7202,7310,7875,1468,8146,9617,4336,8747,7815
gaid	3261cf44cbe6a00839c574336fdf49f6	137.790839567	56.8403675248	7462,1115,5205,6700,865,5317,4967,2104,7993,6357,2385,8639,2306,5712,5326,9929,7781,1402,8830,1978,6443,3372,6379,5426,7847,8485,8983,1938,4809,2095,6887,2720,1074,1499,7165,4922,5969,6655,241,8738,1336,7334,465,4866,3402,634,9813,6343,2686,2214,7140,4818,92,1072,4784,2376,2086,5639,6314,9411,7888,8187,8766,7524,9002,3567,3563,360,8949,2780,8299,2460,1274,1474,3030,2221,3467,9094,9014,4475,4180,2205,481,7125,1237
dvid	94584df26efb6afd43b30609328f3d75	165.364801883	-67.9991374849	4046,5305,7503,1192,1354,4875,6216,529,4067,7003,8900,3945,9099,9054,9322,173,739,3807,5133,8353,4358,2781,6015,5538
idfa	26658aeb53c5c03222c631843cdd7332	-147.210946651	71.561943603	6700,858,9532,3236,7959,8317,6388,681,8245,5269,4705,6292,7872,9589,1585,7849,1363
adid	ca468fbb41ae6bd0b75fde1246a89bd1	48.1968937235	51.05440249	9772,8573,4607,7464,1577,1787,3632,7132,3893,1666,6507,3155,3740,6983,6699,5447,5396,6798,2664,5283,6939,209,3454
gaid	5094cde0cddb48a4ff1614fd9dd513bd	8.08101490477	22.1430848316	6824,4323,6216,3329,1821,1523,5459,7692,4747,5208,4761,9914,8859,3338,1743,6192,7606,2489,5741,3523,1246,2606,9289,356,5073,7280,9401,4100,6056,6968,945,2252,7478,1609,2747,6526,7728,9443,855,8607,8683,2594,5446,4610,9568,4415,8264,3165,8491,8790,5422,2578,2777,7192,1764,5408,7366,9707,7545,1398,3989,5209,4442,458,7892
idfa	aab56963000aad2eaaf515db9ed855d8	-119.489831986	-55.7049523367	1537,2883,3885,432,4161,5585,9449,6117,3799,2540,6627,5774,499,5871,6140,6629,7061,6880,7669,204,4637,3641,497,8976,2163,437,8702,7771,6420,4226,2461,7533,8938,95,6750,3487,6745,3295,8174,9423,608,982,3393,4462,2441,8958,7492,4435,6675,5009,500,2827,7823,4423,4913,1799,6438,4911,1568,213,8546,2363,8465,3572,8410,7086,4384,394
'''

def test_mc_invalid_connect():
   client = mlt.MCRetryingClient("128.1.1.1:8000")
   client.connect()
   with pytest.raises(Exception):
      client.set(1, 'One')


def test_complete():
   dirname = 'tests/test_data/'
   filename = datetime.datetime.now().strftime("%Y%m%d")+'.tsv.gz'

   with gzip.open(dirname+filename, 'wt') as fp:
      fp.write(src)

   op = OptionParser()
   op.add_option("-t", "--test", action="store_true", default=False)
   op.add_option("-w", "--workers", action="store", default=5)
   op.add_option("-l", "--log", action="store", default=None)
   op.add_option("--dry", action="store_true", default=False)
   op.add_option("--pattern", action="store", default=f"{dirname}/*.tsv.gz")
   op.add_option("--idfa", action="store", default="127.0.0.1:11211")
   op.add_option("--gaid", action="store", default="127.0.0.1:11211")
   op.add_option("--adid", action="store", default="127.0.0.1:11211")
   op.add_option("--dvid", action="store", default="127.0.0.1:11211")

   (opts, args) = op.parse_args([])

   device_memc = {
      "idfa": opts.idfa,
      "gaid": opts.gaid,
      "adid": opts.adid,
      "dvid": opts.dvid,
   }

   pipeline = mlt.LogPipeline(opts, device_memc)
   pipeline.run()

   assert pipeline.processed == 9
   assert pipeline.errors == 0
   assert os.path.exists(dirname+'.'+filename)
   os.remove(dirname+'.'+filename)


